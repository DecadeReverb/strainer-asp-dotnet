image: mcr.microsoft.com/dotnet/core/sdk:3.1

variables:
 INTEGRATION_TESTS_PROJECT_NAME: 'Strainer.IntegrationTests'
 UNIT_TESTS_PROJECT_NAME: 'Strainer.UnitTests'
 SOURCE_CODE_DIRECTORY: 'src'
 TEST_DIRECTORY: 'test'
 TEST_COLLECTOR_NAME: 'opencover'
 CODECOV_VERSION: '0.2.4'
 BINARIES_DIRECTORY: 'bin'
 OBJECTS_DIRECTORY: 'obj'
 BUILD_CONFIGURATION: 'Release'
 NUGET_PACKAGES_DIRECTORY: '.nuget'
 NUGET_SERVER_URL: 'https://api.nuget.org/v3/index.json'

stages:
  - build
  - test
  - pack
  - deploy


cache:
 key: '${CI_JOB_STAGE}-${CI_COMMIT_REF_SLUG}'
 paths:
  - '${SOURCE_CODE_DIRECTORY}/*/${OBJECTS_DIRECTORY}/project.assets.json'
  - '${SOURCE_CODE_DIRECTORY}/*/${OBJECTS_DIRECTORY}/*.csproj.nuget.*'
  - '${TEST_DIRECTORY}/*/${OBJECTS_DIRECTORY}/project.assets.json'
  - '${TEST_DIRECTORY}/*/${OBJECTS_DIRECTORY}/*.csproj.nuget.*'
  - '${NUGET_PACKAGES_DIRECTORY}'

before_script:
  - 'dotnet restore --packages ${NUGET_PACKAGES_DIRECTORY}'

build:
 stage: build
 script:
  - 'dotnet build --no-restore --configuration ${BUILD_CONFIGURATION}'
 artifacts:
  paths:
   - '${SOURCE_CODE_DIRECTORY}/*/${BINARIES_DIRECTORY}'
   - '${SOURCE_CODE_DIRECTORY}/*/${OBJECTS_DIRECTORY}'
   - '${TEST_DIRECTORY}/*/${BINARIES_DIRECTORY}'
   - '${TEST_DIRECTORY}/*/${OBJECTS_DIRECTORY}'

unit tests:
 stage: test
 script:
  - 'dotnet test ${TEST_DIRECTORY}/${UNIT_TESTS_PROJECT_NAME} --no-restore --no-build --configuration ${BUILD_CONFIGURATION} /p:CollectCoverage=true /p:CoverletOutputFormat=${TEST_COLLECTOR_NAME}'
  - './${NUGET_PACKAGE_PATH}/codecovuploader/${CODECOV_VERSION}/tools/codecov.exe -f "${TEST_DIRECTORY}/${UNIT_TESTS_PROJECT_NAME}/coverage.opencover.xml" -t ${CODECOV_TOKEN}'
 dependencies:
  - build

integration tests:
 stage: test
 script:
  - 'dotnet test ${TEST_DIRECTORY}/${INTEGRATION_TESTS_PROJECT_NAME} --no-restore --no-build --configuration ${BUILD_CONFIGURATION} /p:CollectCoverage=true /p:CoverletOutputFormat=${TEST_COLLECTOR_NAME}'
  - './${NUGET_PACKAGE_PATH}/codecovuploader/${CODECOV_VERSION}/tools/codecov.exe -f "${TEST_DIRECTORY}/${INTEGRATION_TESTS_PROJECT_NAME}/coverage.opencover.xml" -t ${CODECOV_TOKEN}'
 dependencies:
  - build

pack Strainer:
 stage: pack
 only:
  - master
  - tags
 script:
  - 'dotnet pack ${SOURCE_CODE_DIRECTORY}/Strainer --no-restore --no-build --configuration ${BUILD_CONFIGURATION}'
 artifacts:
  paths:
   - '${SOURCE_CODE_DIRECTORY}/*/${BINARIES_DIRECTORY}'
   - '${SOURCE_CODE_DIRECTORY}/*/${OBJECTS_DIRECTORY}'
 dependencies:
  - build

pack Strainer.AspNetCore:
 stage: pack
 only:
  - master
  - tags
 script:
  - 'dotnet pack ${SOURCE_CODE_DIRECTORY}/Strainer.AspNetCore --no-restore --no-build --configuration ${BUILD_CONFIGURATION}'
 artifacts:
  paths:
   - '${SOURCE_CODE_DIRECTORY}/*/${BINARIES_DIRECTORY}'
   - '${SOURCE_CODE_DIRECTORY}/*/${OBJECTS_DIRECTORY}'
 dependencies:
  - build

deploy Strainer:
 stage: deploy
 only:
  - master
  - tags
 script:
  - 'NUGET_PACKAGE_PATH=$(find $SOURCE_CODE_DIRECTORY/Strainer/${BINARIES_DIRECTORY}/${BUILD_CONFIGURATION} -maxdepth 1 -type f -name "*.nupkg" -printf "%h/%f\n")'
  - 'dotnet nuget push ${NUGET_PACKAGE_PATH} --api-key ${NUGET_API_KEY} --source ${NUGET_SERVER_URL}'
 dependencies:
  - pack Strainer

deploy Strainer.AspNetCore:
 stage: deploy
 only:
  - master
  - tags
 script:
  - 'NUGET_PACKAGE_PATH=$(find $SOURCE_CODE_DIRECTORY/Strainer.AspNetCore/${BINARIES_DIRECTORY}/${BUILD_CONFIGURATION} -maxdepth 1 -type f -name "*.nupkg" -printf "%h/%f\n")'
  - 'dotnet nuget push ${NUGET_PACKAGE_PATH} --api-key ${NUGET_API_KEY} --source ${NUGET_SERVER_URL}'
 dependencies:
  - pack Strainer.AspNetCore
